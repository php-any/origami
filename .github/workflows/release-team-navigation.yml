name: Release Team Navigation Example

on:
  push:
    tags:
      - "team-navigation-v*"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          # Windows ARM64 support is limited
          - goos: windows
            goarch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23.6"

      - name: Get dependencies
        run: go mod download

      - name: Build team-navigation binary
        working-directory: examples/team-navigation
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          # ç¡®ä¿ä½¿ç”¨æœ¬åœ° origami æ¨¡å—
          go mod edit -replace github.com/php-any/origami=../../
          go mod download
          go mod tidy
          if [ "$GOOS" = "windows" ]; then
            go build -o team-navigation.exe ./main.go
          else
            go build -o team-navigation ./main.go
          fi

      - name: Create package directory
        working-directory: examples/team-navigation
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          if [ "$GOOS" = "windows" ]; then
            cp team-navigation.exe team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/
          else
            cp team-navigation team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/
          fi
          
          # å¤åˆ¶æ‰€æœ‰è„šæœ¬æ–‡ä»¶
          mkdir -p team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/src
          cp -r src/* team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/src/
          
          # å¤åˆ¶æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
          mkdir -p team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/database
          cp -r database/*.zy team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/database/ 2>/dev/null || true
          
          # å¤åˆ¶ HTTP é…ç½®è„šæœ¬
          cp http.zy team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/ 2>/dev/null || true
          
          # å¤åˆ¶é¡µé¢æ–‡ä»¶
          mkdir -p team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/pages
          cp -r pages/* team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/pages/ 2>/dev/null || true
          
          # å¤åˆ¶ go.mod å’Œ go.sumï¼ˆå¯é€‰ï¼Œç”¨äºŽå‚è€ƒï¼‰
          cp go.mod team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/ 2>/dev/null || true
          cp go.sum team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/ 2>/dev/null || true
          
          # åˆ›å»ºè¿è¡Œè„šæœ¬
          if [ "$GOOS" = "windows" ]; then
            echo '@echo off' > team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/run.bat
            echo 'team-navigation.exe' >> team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/run.bat
          else
            echo '#!/bin/bash' > team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/run.sh
            echo './team-navigation' >> team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/run.sh
            chmod +x team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/run.sh
          fi
          
          # åˆ›å»º README æ–‡ä»¶
          cat > team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/README.md << 'EOF'
          # Team Navigation Example - ${{ matrix.goos }}-${{ matrix.goarch }}

          ## æ–‡ä»¶è¯´æ˜Ž
          - `team-navigation` / `team-navigation.exe`: ä¸»ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶
          - `run.sh` / `run.bat`: è¿è¡Œè„šæœ¬
          - `http.zy`: HTTP æœåŠ¡å™¨é…ç½®è„šæœ¬
          - `src/`: æºä»£ç ç›®å½•ï¼ˆåŒ…å«æŽ§åˆ¶å™¨ã€æ¨¡åž‹ã€è§†å›¾ï¼‰
          - `database/`: æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
          - `pages/`: é™æ€é¡µé¢èµ„æºï¼ˆHTMLã€CSSã€JSï¼‰

          ## ä½¿ç”¨æ–¹æ³•

          EOF
          
          if [ "$GOOS" = "windows" ]; then
            cat >> team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/README.md << 'EOF'
          ```cmd
          run.bat
          ```
          
          æœåŠ¡å™¨å°†åœ¨ http://127.0.0.1:8080 å¯åŠ¨
          EOF
          else
            cat >> team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/README.md << 'EOF'
          ```bash
          ./run.sh
          ```
          
          æœåŠ¡å™¨å°†åœ¨ http://127.0.0.1:8080 å¯åŠ¨
          EOF
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}
          path: examples/team-navigation/team-navigation-${{ matrix.goos }}-${{ matrix.goarch }}/
          if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/team-navigation-v')

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Team Navigation Example ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## Team Navigation Example ${{ github.ref_name }}

            ### ä¸‹è½½è¯´æ˜Ž
            æ¯ä¸ªå¹³å°éƒ½åŒ…å«å®Œæ•´çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ‰€æœ‰è„šæœ¬æ–‡ä»¶ï¼Œè§£åŽ‹åŽå³å¯ä½¿ç”¨ï¼š

            #### å¹³å°åŒ…
            - `team-navigation-linux-amd64.tar.gz`: Linux x64 ç‰ˆæœ¬
            - `team-navigation-linux-arm64.tar.gz`: Linux ARM64 ç‰ˆæœ¬
            - `team-navigation-darwin-amd64.tar.gz`: macOS Intel ç‰ˆæœ¬
            - `team-navigation-darwin-arm64.tar.gz`: macOS Apple Silicon ç‰ˆæœ¬
            - `team-navigation-windows-amd64.zip`: Windows x64 ç‰ˆæœ¬

            ### ä½¿ç”¨æ–¹æ³•
            ```bash
            # Linux/macOS
            tar -xzf team-navigation-linux-amd64.tar.gz
            cd team-navigation-linux-amd64
            ./run.sh

            # Windows
            # è§£åŽ‹ team-navigation-windows-amd64.zip
            # åŒå‡» run.bat æˆ–åœ¨å‘½ä»¤è¡Œè¿è¡Œ: run.bat
            ```

            æœåŠ¡å™¨å°†åœ¨ `http://127.0.0.1:8080` å¯åŠ¨

            ### åŒ…å†…å®¹
            æ¯ä¸ªå¹³å°åŒ…éƒ½åŒ…å«ï¼š
            - `team-navigation` / `team-navigation.exe`: ä¸»ç¨‹åºäºŒè¿›åˆ¶æ–‡ä»¶
            - `run.sh` / `run.bat`: è¿è¡Œè„šæœ¬
            - `http.zy`: HTTP æœåŠ¡å™¨é…ç½®è„šæœ¬
            - `src/`: æºä»£ç ç›®å½•ï¼ˆæŽ§åˆ¶å™¨ã€æ¨¡åž‹ã€è§†å›¾ï¼‰
            - `database/`: æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
            - `pages/`: é™æ€é¡µé¢èµ„æºï¼ˆHTMLã€CSSã€JSï¼‰
            - `README.md`: ä½¿ç”¨è¯´æ˜Ž

            ### é¡¹ç›®è¯´æ˜Ž
            è¿™æ˜¯ä¸€ä¸ªåŸºäºŽ Origami-lang çš„å›¢é˜Ÿå†…éƒ¨å¯¼èˆªé¡µç³»ç»Ÿï¼Œç”¨äºŽå¿«é€Ÿè®¿é—®å¸¸ç”¨å·¥å…·é“¾æŽ¥å’Œé¡¹ç›®ä¸åŒçŽ¯å¢ƒçš„åœ°å€ã€‚

            - ðŸ› ï¸ **å¸¸ç”¨å·¥å…·å¯¼èˆª**ï¼šå¿«é€Ÿè®¿é—® GitLabã€Jiraã€Jenkinsã€Grafana ç­‰å¸¸ç”¨å·¥å…·
            - ðŸŒ **é¡¹ç›®çŽ¯å¢ƒç®¡ç†**ï¼šé›†ä¸­ç®¡ç†é¡¹ç›®åœ¨ä¸åŒçŽ¯å¢ƒçš„è®¿é—®åœ°å€
            - ðŸ” **å¿«é€Ÿæœç´¢**ï¼šæ”¯æŒæœç´¢å·¥å…·å’Œé¡¹ç›®çŽ¯å¢ƒ
            - ðŸ“± **å“åº”å¼è®¾è®¡**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸

      - name: Upload Release Assets
        run: |
          # åˆ—å‡ºå½“å‰ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶
          echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la
          
          # æŸ¥æ‰¾æ‰€æœ‰å¹³å°ç›®å½•
          echo "æŸ¥æ‰¾å¹³å°ç›®å½•ï¼š"
          find . -type d -name "team-navigation-*"
          
          # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºåŽ‹ç¼©åŒ…å¹¶ä¸Šä¼ 
          for dir in team-navigation-*; do
            if [ -d "$dir" ]; then
              echo "å¤„ç†ç›®å½•: $dir"
              
              # æ ¹æ®ç›®å½•ååˆ¤æ–­å¹³å°ç±»åž‹
              if [[ "$dir" == *"windows"* ]]; then
                # Windows ä½¿ç”¨ zip
                echo "åˆ›å»º Windows åŽ‹ç¼©åŒ…: $dir.zip"
                cd "$dir"
                zip -r "../$dir.zip" .
                cd ..
                
                if [ -f "$dir.zip" ]; then
                  echo "ä¸Šä¼ : $dir.zip"
                  gh release upload ${{ github.ref_name }} "$dir.zip" --clobber
                fi
              else
                # Linux/macOS ä½¿ç”¨ tar.gz
                echo "åˆ›å»º Unix åŽ‹ç¼©åŒ…: $dir.tar.gz"
                tar -czf "$dir.tar.gz" "$dir/"
                
                if [ -f "$dir.tar.gz" ]; then
                  echo "ä¸Šä¼ : $dir.tar.gz"
                  gh release upload ${{ github.ref_name }} "$dir.tar.gz" --clobber
                fi
              fi
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

