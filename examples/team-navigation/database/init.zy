namespace Database;

/**
 * æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
 * è´Ÿè´£åˆ›å»ºè¡¨ç»“æ„å’Œåˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
 */

/**
 * åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„
 * @param $db æ•°æ®åº“è¿æ¥å¯¹è±¡
 */
function initTables($db) {
    Log::info("åˆ›å»ºæ•°æ®åº“è¡¨...");

    // åˆ›å»ºå·¥å…·é“¾æ¥è¡¨
    $createToolLinksTable = "
        CREATE TABLE IF NOT EXISTS tool_links (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name VARCHAR(100) NOT NULL,
            url VARCHAR(500) NOT NULL,
            icon VARCHAR(50),
            category VARCHAR(50),
            description TEXT,
            is_favorite INTEGER DEFAULT 0,
            display_order INTEGER DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )";
    
    $result1 = $db->exec($createToolLinksTable);
    Log::info("åˆ›å»ºå·¥å…·é“¾æ¥è¡¨ç»“æœ: " + $result1);

    // åˆ›å»ºé¡¹ç›®è¡¨
    $createProjectsTable = "
        CREATE TABLE IF NOT EXISTS projects (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name VARCHAR(100) NOT NULL,
            description TEXT,
            icon VARCHAR(500),
            display_order INTEGER DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )";

    $result2 = $db->exec($createProjectsTable);
    Log::info("åˆ›å»ºé¡¹ç›®è¡¨ç»“æœ: " + $result2);
    
    // å¦‚æœè¡¨å·²å­˜åœ¨ä½†æ²¡æœ‰ icon å­—æ®µï¼Œåˆ™æ·»åŠ è¯¥å­—æ®µ
    $addIconColumn = "
        ALTER TABLE projects ADD COLUMN icon VARCHAR(500);
    ";
    try {
        $db->exec($addIconColumn);
        Log::info("æ·»åŠ é¡¹ç›®è¡¨ icon å­—æ®µæˆåŠŸ");
    } catch (_) {
        // å­—æ®µå·²å­˜åœ¨æˆ–è¡¨ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
        Log::info("é¡¹ç›®è¡¨ icon å­—æ®µå¯èƒ½å·²å­˜åœ¨æˆ–è¡¨ä¸å­˜åœ¨");
    }

    // åˆ›å»ºé¡¹ç›®ç¯å¢ƒè¡¨
    $createProjectEnvsTable = "
        CREATE TABLE IF NOT EXISTS project_environments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            project_id INTEGER NOT NULL,
            environment_name VARCHAR(50) NOT NULL,
            url VARCHAR(500) NOT NULL,
            status VARCHAR(20) DEFAULT 'è¿è¡Œä¸­',
            status_color VARCHAR(20) DEFAULT 'green',
            display_order INTEGER DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
        )";

    $result3 = $db->exec($createProjectEnvsTable);
    Log::info("åˆ›å»ºé¡¹ç›®ç¯å¢ƒè¡¨ç»“æœ: " + $result3);

    // åˆ›å»ºé¡¹ç›®ä¸å·¥å…·å…³è”è¡¨
    $createProjectToolsTable = "
        CREATE TABLE IF NOT EXISTS project_tools (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            project_id INTEGER NOT NULL,
            tool_id INTEGER NOT NULL,
            display_order INTEGER DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE,
            FOREIGN KEY (tool_id) REFERENCES tool_links (id) ON DELETE CASCADE,
            UNIQUE(project_id, tool_id)
        )";

    $result4 = $db->exec($createProjectToolsTable);
    Log::info("åˆ›å»ºé¡¹ç›®å·¥å…·å…³è”è¡¨ç»“æœ: " + $result4);

    // åˆ›å»ºæœç´¢å¼•æ“è¡¨
    $createSearchEnginesTable = "
        CREATE TABLE IF NOT EXISTS search_engines (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name VARCHAR(100) NOT NULL,
            url_template VARCHAR(500) NOT NULL,
            icon VARCHAR(50),
            is_default INTEGER DEFAULT 0,
            display_order INTEGER DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )";

    $result5 = $db->exec($createSearchEnginesTable);
    Log::info("åˆ›å»ºæœç´¢å¼•æ“è¡¨ç»“æœ: " + $result5);
}

/**
 * åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
 * @param $db æ•°æ®åº“è¿æ¥å¯¹è±¡
 * @param $dbExists æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
 */
function initSampleData($db, $dbExists) {
    // æ£€æŸ¥å·¥å…·é“¾æ¥è¡¨æ˜¯å¦æœ‰æ•°æ®
    $toolCount = 0;
    try {
        $row = $db->queryRow("SELECT COUNT(*) FROM tool_links");
        $row->scan($toolCount);
    } catch (Exception $e) {
        // è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
        $toolCount = 0;
    }

    // å¦‚æœæ˜¯æ–°æ•°æ®åº“æˆ–è¡¨ä¸ºç©ºï¼Œåˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
    $toolIdMap = [];
    if (!$dbExists || $toolCount == 0) {
        Log::info("åˆå§‹åŒ–ç¤ºä¾‹å·¥å…·é“¾æ¥æ•°æ®...");
        $initTools = [
            ["GitLab", "https://gitlab.com", "/assets/icons/gitlab.png", "ä»£ç ç®¡ç†", "ä»£ç ä»“åº“å’Œ CI/CD", 1],
            ["Jira", "https://www.atlassian.com/software/jira", "/assets/icons/jira.png", "é¡¹ç›®ç®¡ç†", "ä»»åŠ¡è·Ÿè¸ªå’Œé—®é¢˜ç®¡ç†", 2],
            ["Jenkins", "https://www.jenkins.io", "/assets/icons/jenkins.png", "CI/CD", "æŒç»­é›†æˆå’Œéƒ¨ç½²", 3],
            ["Grafana", "https://grafana.com", "/assets/icons/grafana.png", "ç›‘æ§", "ç›‘æ§å’Œå¯è§†åŒ–", 4],
            ["Prometheus", "https://prometheus.io", "/assets/icons/prometheus.png", "ç›‘æ§", "æŒ‡æ ‡ç›‘æ§ç³»ç»Ÿ", 5],
            ["Kibana", "https://www.elastic.co/kibana", "/assets/icons/kibana.png", "æ—¥å¿—", "æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ", 6],
            ["Confluence", "https://www.atlassian.com/software/confluence", "/assets/icons/confluence.png", "æ–‡æ¡£", "å›¢é˜Ÿæ–‡æ¡£å’ŒçŸ¥è¯†åº“", 7],
            ["SonarQube", "https://www.sonarqube.org", "/assets/icons/sonarqube.png", "ä»£ç è´¨é‡", "ä»£ç è´¨é‡æ£€æµ‹", 8],
            ["Nexus", "https://www.sonatype.com/products/nexus-repository", "/assets/icons/nexus.png", "åˆ¶å“", "Maven/NPM ä»“åº“", 9],
            ["VPN", "https://vpn.example.com", "/assets/icons/vpn.png", "ç½‘ç»œ", "VPN è¿æ¥", 10],
            ["Harbor", "https://goharbor.io", "/assets/icons/harbor.png", "å®¹å™¨", "å®¹å™¨é•œåƒä»“åº“", 11],
            ["Kubernetes", "https://kubernetes.io", "/assets/icons/kubernetes.png", "å®¹å™¨", "å®¹å™¨ç¼–æ’å¹³å°", 12],
            ["Redis", "https://redis.io", "/assets/icons/redis.png", "ç¼“å­˜", "å†…å­˜æ•°æ®åº“å’Œç¼“å­˜", 13],
            ["MySQL", "https://www.mysql.com", "/assets/icons/mysql.png", "æ•°æ®åº“", "å…³ç³»å‹æ•°æ®åº“ç®¡ç†", 14],
            ["Postman", "https://www.postman.com", "/assets/icons/postman.png", "å¼€å‘å·¥å…·", "API æµ‹è¯•å’Œæ–‡æ¡£", 15],
            ["Swagger", "https://swagger.io", "/assets/icons/swagger.png", "å¼€å‘å·¥å…·", "API æ–‡æ¡£å’Œæµ‹è¯•", 16],
            ["Sentry", "https://sentry.io", "/assets/icons/sentry.png", "ç›‘æ§", "é”™è¯¯è¿½è¸ªå’Œç›‘æ§", 17],
            ["Artifactory", "https://jfrog.com/artifactory/", "/assets/icons/artifactory.png", "åˆ¶å“", "ç»Ÿä¸€åˆ¶å“ä»“åº“", 18],
            ["MinIO", "https://min.io", "/assets/icons/minio.png", "å­˜å‚¨", "å¯¹è±¡å­˜å‚¨æœåŠ¡", 19],
            ["Portainer", "https://www.portainer.io", "/assets/icons/portainer.png", "å®¹å™¨", "Docker ç®¡ç†ç•Œé¢", 20]
        ];
        
        for ($i = 0; $i < $initTools->length; $i++) {
            $tool = $initTools[$i];
            // å‰10ä¸ªå·¥å…·è‡ªåŠ¨æ”¶è—ï¼Œå10ä¸ªä¸æ”¶è—
            $isFavorite = $i < 10 ? 1 : 0;
            $result = $db->exec("INSERT INTO tool_links (name, url, icon, category, description, is_favorite, display_order) VALUES (?, ?, ?, ?, ?, ?, ?)", 
                $tool[0], $tool[1], $tool[2], $tool[3], $tool[4], $isFavorite, $tool[5]);
            $toolId = $result->lastInsertId();
            // ä½¿ç”¨ display_order ä½œä¸º keyï¼Œä¿å­˜å®é™…æ’å…¥çš„ ID
            $toolIdMap[$tool[5]] = $toolId;
        }
    } else {
        // å¦‚æœå·¥å…·å·²å­˜åœ¨ï¼ŒæŸ¥è¯¢ç°æœ‰å·¥å…·çš„ ID
        $existingTools = $db->queryRows("SELECT id, display_order FROM tool_links ORDER BY display_order ASC");
        for (_, $tool in $existingTools) {
            $toolIdMap[$tool->display_order] = $tool->id;
        }
    }

    // æ£€æŸ¥é¡¹ç›®è¡¨æ˜¯å¦æœ‰æ•°æ®
    $projectCount = 0;
    try {
        $row = $db->queryRow("SELECT COUNT(*) FROM projects");
        $row->scan($projectCount);
    } catch (Exception $e) {
        // è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
        $projectCount = 0;
    }

    // å¦‚æœæ˜¯æ–°æ•°æ®åº“æˆ–é¡¹ç›®è¡¨ä¸ºç©ºï¼Œåˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
    if (!$dbExists || $projectCount == 0) {
        Log::info("åˆå§‹åŒ–ç¤ºä¾‹é¡¹ç›®æ•°æ®...");
        // ä½¿ç”¨å·¥å…· display_order ä½œä¸º keyï¼Œæ˜ å°„åˆ°å®é™…çš„ tool_id
        // ç»“æ„: [name, display_order, description, icon, tools(orderId[])]
        $initProjects = [
            ["Origami", 1, "æŠ˜è¨€è„šæœ¬è¯­è¨€ä¸è¿è¡Œæ—¶ç¤ºä¾‹é¡¹ç›®", "ğŸ¨", [1, 3, 7]],
            ["Web API", 2, "é¢å‘ä¸šåŠ¡çš„ REST API æœåŠ¡ï¼Œæä¾›å¯¹å¤–æ¥å£", "ğŸŒ", [1, 3, 4]],
            ["Admin åå°", 3, "å†…éƒ¨è¿è¥ä¸é…ç½®ç®¡ç†åå°ç³»ç»Ÿ", "âš™ï¸", [1, 2, 6]],
            ["Mobile App", 4, "ç§»åŠ¨ç«¯åº”ç”¨çš„åç«¯ä¸é›†æˆæœåŠ¡", "ğŸ“±", [1, 3, 8]]
        ];
        
        for (_, $project in $initProjects) {
            $result = $db->exec("INSERT INTO projects (name, description, icon, display_order) VALUES (?, ?, ?, ?)", 
                $project[0], $project[2], $project[3], $project[1]);
            $projectId = $result->lastInsertId();
            
            // ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºé»˜è®¤ç¯å¢ƒ
            $defaultEnvs = [
                ["å¼€å‘ç¯å¢ƒ", "https://github.com/php-any/origami", "è¿è¡Œä¸­", "green"],
                ["æµ‹è¯•ç¯å¢ƒ", "https://github.com/php-any/origami", "è¿è¡Œä¸­", "green"],
                ["ç”Ÿäº§ç¯å¢ƒ", "https://github.com/php-any/origami", "è¿è¡Œä¸­", "green"]
            ];
            
            for (_, $env in $defaultEnvs) {
                $db->exec("INSERT INTO project_environments (project_id, environment_name, url, status, status_color) VALUES (?, ?, ?, ?, ?)", 
                    $projectId, $env[0], $env[1], $env[2], $env[3]);
            }
            
            // ç»‘å®šé¡¹ç›®å…³è”çš„å·¥å…·ï¼ˆä½¿ç”¨ toolIdMap è·å–å®é™…çš„å·¥å…·IDï¼‰
            $toolOrderIds = $project[4];
            for ($i = 0; $i < $toolOrderIds->length; $i++) {
                $toolOrderId = $toolOrderIds[$i];
                $actualToolId = $toolIdMap[$toolOrderId];
                if ($actualToolId != null) {
                    $db->exec("INSERT INTO project_tools (project_id, tool_id, display_order) VALUES (?, ?, ?)", 
                        $projectId, $actualToolId, $i + 1);
                }
            }
        }
    }

    // æ£€æŸ¥æœç´¢å¼•æ“è¡¨æ˜¯å¦æœ‰æ•°æ®
    $searchEngineCount = 0;
    try {
        $row = $db->queryRow("SELECT COUNT(*) FROM search_engines");
        $row->scan($searchEngineCount);
    } catch (Exception $e) {
        // è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
        $searchEngineCount = 0;
    }

    // å¦‚æœæ˜¯æ–°æ•°æ®åº“æˆ–æœç´¢å¼•æ“è¡¨ä¸ºç©ºï¼Œåˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
    if (!$dbExists || $searchEngineCount == 0) {
        Log::info("åˆå§‹åŒ–æœç´¢å¼•æ“æ•°æ®...");
        $initSearchEngines = [
            ["ç™¾åº¦", "https://www.baidu.com/s?wd={keyword}", "ğŸ”", 1, 1],
            ["Google", "https://www.google.com/search?q={keyword}", "ğŸŒ", 0, 2],
            ["Bing", "https://www.bing.com/search?q={keyword}", "ğŸ”", 0, 3],
            ["GitHub", "https://github.com/search?q={keyword}", "ğŸ’»", 0, 4],
            ["DuckDuckGo", "https://duckduckgo.com/?q={keyword}", "ğŸ¦†", 0, 5]
        ];
        
        for (_, $engine in $initSearchEngines) {
            $db->exec("INSERT INTO search_engines (name, url_template, icon, is_default, display_order) VALUES (?, ?, ?, ?, ?)", 
                $engine[0], $engine[1], $engine[2], $engine[3], $engine[4]);
        }
    }
}

