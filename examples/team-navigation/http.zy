namespace App;

use Net\Http\Server;
use Net\Http\app;
use Database\Sql\open;

// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
Log::info("=== åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ ===");

// æ³¨å†Œ SQLite æ•°æ®åº“è¿æ¥
$db = open("sqlite", "team_navigation.db");
$db->ping();
Database\registerDefaultConnection($db);

// åˆ›å»ºæ•°æ®åº“è¡¨
Log::info("åˆ›å»ºæ•°æ®åº“è¡¨...");

// åˆ›å»ºå·¥å…·é“¾æ¥è¡¨
$createToolLinksTable = "
CREATE TABLE IF NOT EXISTS tool_links (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    url VARCHAR(500) NOT NULL,
    icon VARCHAR(50),
    category VARCHAR(50),
    description TEXT,
    display_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
)";

$result1 = $db->exec($createToolLinksTable);
Log::info("åˆ›å»ºå·¥å…·é“¾æ¥è¡¨ç»“æœ: " + $result1);

// åˆ›å»ºé¡¹ç›®è¡¨
$createProjectsTable = "
CREATE TABLE IF NOT EXISTS projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    display_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
)";

$result2 = $db->exec($createProjectsTable);
Log::info("åˆ›å»ºé¡¹ç›®è¡¨ç»“æœ: " + $result2);

// åˆ›å»ºé¡¹ç›®ç¯å¢ƒè¡¨
$createProjectEnvsTable = "
CREATE TABLE IF NOT EXISTS project_environments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    environment_name VARCHAR(50) NOT NULL,
    url VARCHAR(500) NOT NULL,
    status VARCHAR(20) DEFAULT 'è¿è¡Œä¸­',
    status_color VARCHAR(20) DEFAULT 'green',
    display_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
)";

$result3 = $db->exec($createProjectEnvsTable);
Log::info("åˆ›å»ºé¡¹ç›®ç¯å¢ƒè¡¨ç»“æœ: " + $result3);

// åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®ï¼ˆå¦‚æœè¡¨ä¸ºç©ºï¼‰
$toolCountResult = $db->query("SELECT COUNT(*) as count FROM tool_links");
$toolCount = 0;
try {
    if ($toolCountResult != null) {
        if ($toolCountResult instanceof object && $toolCountResult->count != null) {
            $toolCount = (int)$toolCountResult->count;
        } else {
            $toolCount = (int)$toolCountResult;
        }
    }
} catch (Exception $e) {
    $toolCount = 0;
}

if ($toolCount == 0) {
    Log::info("åˆå§‹åŒ–ç¤ºä¾‹å·¥å…·é“¾æ¥æ•°æ®...");
    $initTools = [
        ["GitLab", "https://gitlab.example.com", "ğŸ”—", "ä»£ç ç®¡ç†", "ä»£ç ä»“åº“å’Œ CI/CD", 1],
        ["Jira", "https://jira.example.com", "ğŸ“‹", "é¡¹ç›®ç®¡ç†", "ä»»åŠ¡è·Ÿè¸ªå’Œé—®é¢˜ç®¡ç†", 2],
        ["Jenkins", "https://jenkins.example.com", "âš™ï¸", "CI/CD", "æŒç»­é›†æˆå’Œéƒ¨ç½²", 3],
        ["Grafana", "https://grafana.example.com", "ğŸ“Š", "ç›‘æ§", "ç›‘æ§å’Œå¯è§†åŒ–", 4],
        ["Prometheus", "https://prometheus.example.com", "ğŸ“ˆ", "ç›‘æ§", "æŒ‡æ ‡ç›‘æ§ç³»ç»Ÿ", 5],
        ["Kibana", "https://kibana.example.com", "ğŸ”", "æ—¥å¿—", "æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ", 6],
        ["Confluence", "https://confluence.example.com", "ğŸ“–", "æ–‡æ¡£", "å›¢é˜Ÿæ–‡æ¡£å’ŒçŸ¥è¯†åº“", 7],
        ["SonarQube", "https://sonarqube.example.com", "ğŸ”", "ä»£ç è´¨é‡", "ä»£ç è´¨é‡æ£€æµ‹", 8],
        ["Nexus", "https://nexus.example.com", "ğŸ“¦", "åˆ¶å“", "Maven/NPM ä»“åº“", 9],
        ["VPN", "https://vpn.example.com", "ğŸ”", "ç½‘ç»œ", "VPN è¿æ¥", 10]
    ];
    
    for ($tool in $initTools) {
        $db->exec("INSERT INTO tool_links (name, url, icon, category, description, display_order) VALUES (?, ?, ?, ?, ?, ?)", 
            $tool[0], $tool[1], $tool[2], $tool[3], $tool[4], $tool[5]);
    }
}

$projectCountResult = $db->query("SELECT COUNT(*) as count FROM projects");
$projectCount = 0;
try {
    if ($projectCountResult != null) {
        if ($projectCountResult instanceof object && $projectCountResult->count != null) {
            $projectCount = (int)$projectCountResult->count;
        } else {
            $projectCount = (int)$projectCountResult;
        }
    }
} catch (Exception $e) {
    $projectCount = 0;
}

if ($projectCount == 0) {
    Log::info("åˆå§‹åŒ–ç¤ºä¾‹é¡¹ç›®æ•°æ®...");
    $initProjects = [
        ["Origami", 1],
        ["Web API", 2],
        ["Admin åå°", 3],
        ["Mobile App", 4]
    ];
    
    for ($project in $initProjects) {
        $result = $db->exec("INSERT INTO projects (name, display_order) VALUES (?, ?)", 
            $project[0], $project[1]);
        $projectId = $result->lastInsertId;
        
        // ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºé»˜è®¤ç¯å¢ƒ
        $projectNameRaw = $project[0];
        $projectNameLower = $projectNameRaw->toLowerCase()->replace(" ", "-")->replace("api", "api")->replace("admin", "admin")->replace("app", "app");
        $defaultEnvs = [
            ["å¼€å‘ç¯å¢ƒ", "http://dev-" + $projectNameLower + ".example.com", "è¿è¡Œä¸­", "green"],
            ["æµ‹è¯•ç¯å¢ƒ", "http://test-" + $projectNameLower + ".example.com", "è¿è¡Œä¸­", "green"],
            ["ç”Ÿäº§ç¯å¢ƒ", "https://" + $projectNameLower + ".example.com", "è¿è¡Œä¸­", "green"]
        ];
        
        for ($env in $defaultEnvs) {
            $db->exec("INSERT INTO project_environments (project_id, environment_name, url, status, status_color) VALUES (?, ?, ?, ?, ?)", 
                $projectId, $env[0], $env[1], $env[2], $env[3]);
        }
    }
}

$server = new Server("0.0.0.0", port: 8080);

// ç®€å•çš„æ—¥å¿—ä¸­é—´ä»¶
$server->middleware(($request, $response, $next) => {
    $method = $request->method();
    $path = $request->path();
    Log::info("HTTP " + $method + " " + $path);
    $next($request, $response);
});

// API è·¯ç”±é€šè¿‡æ³¨è§£é©±åŠ¨ï¼Œæ— éœ€æ‰‹åŠ¨æ³¨å†Œ

// åŒ¹é…ä»»æ„æ–¹æ³• + ä»»æ„è·¯ç”±ï¼Œç»Ÿä¸€äº¤ç»™ app åˆ†å‘
$server->any(($request, $response) => {
    app($request, $response)
});

// é™æ€èµ„æºè§£æï¼šå°† /assets/* æ˜ å°„åˆ° ./pages ç›®å½•
$server->static("/assets/", "./pages/assets");

Log::info("å›¢é˜Ÿå¯¼èˆªé¡µæœåŠ¡å¯åŠ¨åœ¨: http://127.0.0.1:8080");
$server->run();

